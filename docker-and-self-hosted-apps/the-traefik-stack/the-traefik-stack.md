---
parent: Docker
---

# The Traefik Docker Stack

## What is Traefik?

The simplest, most comprehensive cloud-native stack to help enterprises manage their entire network across data centers, on-premises servers and public clouds all the way out to the edge.

[Traefik Official Website](https://traefik.io/)

![Traefik Screenshot](images/traefik-architecture.png "Traefik Screenshot")

## What does it do?

It acts like a proxy server between your applcation and the browser. It adds a level of security with autogenerated SSL certificates via LetsEncrypt

## What is Authelia

Authelia is an open-source authentication and authorization server protecting modern web applications by collaborating with reverse proxies such as NGINX, Traefik and HAProxy. Consequently, no code is required to protect your apps.

![Authelia Screenshot](images/authelia-archi.png "Authelia Screenshot")

## What does it do  ?

Enable your users to login once and access everything.

[Authelia Official Website](https://www.authelia.com/)

# Basics

## Traefik Basics

Trafic supports different types of providers to supply configuration to it. We are using [Docker provider](https://doc.traefik.io/traefik/providers/docker/) and [File provider](https://doc.traefik.io/traefik/providers/file/) here.

### Docker Provider 

It is used to configure our proxy through Docker labels.

### File Provider

Since Docker provider does not support proxying external URLs we are using file provider.


## Prerequisite

 - A Mechine with `docker` and `docker-compose` installed
 - Cloudflare account (Optional).
 - Portainer (Optional)
 - Lots of patience

### My setup

 - Raspberry Pi 4 - 4G running [DietPi](https://dietpi.com/)
 - WD Green 240 GB SSD Connected [Amazon](https://www.amazon.in/Western-Digital-WDS240G2G0A-240GB-Internal/dp/B076Y374ZH)
 - Orico Enclosure USB3.1 Gen 2 [Amazon](https://www.amazon.in/ORICO-External-Drive-Enclosure-Type-C/dp/B07RM4HLFH/) 
 - Connected via Ethernet

# Installation 

My storage locatio  is `/mnt/dietpi_userdata/traefik`

The domain I will be using is lan.ha-india.com

## Create a dedicated network for connecting all containers and stacks

```shell
$ sudo docker network create --driver=bridge --attachable traefik-public
725626e1ece9d2b292a551c441140a94c23a24588860022998ebf83f9b403cf7
```

You can create a network in Portainer from `Networks -> Add Network`, Select Driver Bridge, and turn on `Enable manual container attachment`

## Create Traefik stack 

Important Notes:

 - The Traefik itself will be using `traefik.lan.ha-india.com` domain .

 - Traefik requires you to define "Certificate Resolvers" in the configuration, which is responsible for retrieving certificates from an ACME server.

 - We will be using the resolver name `letsencrypt`, just a name you can use anything.

 - The configuration below is used to create a wildcard cert for all domains under `lan.ha-india.com` since LetsEncrypt comes with [rate limits](https://letsencrypt.org/docs/rate-limits/) .

```
      - 'traefik.http.routers.traefik.tls.domains[0].main=lan.ha-india.com'
      - 'traefik.http.routers.traefik.tls.domains[0].sans=*.lan.ha-india.com'
```

- In Dynamic Configuration `local-ip` should be replaced with your Raspberry Pi / VM IP, this once is used for proxying all the devices running in the docker `host` network. All docker containers are configured through the Portainer itself.

### Create folders

`mkdir -p /mnt/dietpi_userdata/traefik/confs`

`nano /mnt/dietpi_userdata/traefik/confs/traefik.yml`

```
## traefik.yml

# Docker configuration backend
providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
  file:
    filename: "traefik.yml"
    directory: "/etc/traefik"
    watch: true

# API and dashboard configuration
api:
  insecure: true

entryPoints:
  web:
    address: ":80"
    http:
      redirections: # Force redirect to https 
        entryPoint:
          permanent: true
          to: websecure
          scheme: https
  websecure:
    address: ":443"

certificatesResolvers:
  letsencrypt:
    acme:
      #caServer: https://acme-staging-v02.api.letsencrypt.org/directory
      storage: /letsencrypt/acme.json
      email: your-email@gmail.com
      dnschallenge:
        provider: cloudflare

## DYNAMIC CONFIGURATION
http:
  routers:

    esphome:
      rule: "Host(`esphome.lan.ha-india.com`)"
      service: esphome-service
      priority: 1000
      tls:
        certresolver: letsencrypt
      entryPoints:
        - websecure

    homeassistant:
      rule: "Host(`ha.lan.ha-india.com`)"
      service: homeassistant-service
      priority: 1000
      tls:
        certresolver: letsencrypt
      entryPoints:
        - websecure

  services:

    esphome-service:
      loadBalancer:
        servers:
          - url: "http://local-ip:6052"

    homeassistant-service:
      loadBalancer:
        servers:
          - url: "http://local-ip:8123"

```

Create a new stack named `traefik` in portainer

```
version: "3.3"

services:

  traefik:
    image: "traefik:v2.5"
    container_name: "traefik"
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.traefik.rule=Host(`traefik.lan.ha-india.com`)'
      - 'traefik.http.routers.traefik.entrypoints=websecure'
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - 'traefik.http.routers.traefik.tls=true'
      - 'traefik.http.routers.traefik.tls.domains[0].main=lan.ha-india.com'
      - 'traefik.http.routers.traefik.tls.domains[0].sans=*.lan.ha-india.com'
      - 'traefik.http.services.traefik.loadbalancer.server.port=8080'
      - "traefik.docker.network=traefik-public"
    environment:
      - "CF_API_EMAIL=your-email@gmail.com"
      - "CF_API_KEY=cloudflare-api-key-here"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - "/mnt/dietpi_userdata/traefik/letsencrypt:/letsencrypt" # used for storing certifcates and l3 related data
      - "/mnt/dietpi_userdata/traefik/confs:/etc/traefik" # file provider for Traefik
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    restart: unless-stopped
    networks:
      - traefik-public

networks:
  traefik-public:
    external: true
  traefik-swarm:
    external: true
    
```